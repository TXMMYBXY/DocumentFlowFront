<UserControl x:Class="DocumentFlowing.Views.Controls.UserView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:controls="clr-namespace:DocumentFlowing.ViewModels.Controls"
             xmlns:converters="clr-namespace:DocumentFlowing.Common"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800"
             d:DataContext="{d:DesignInstance controls:UserViewModel}">
    
    <UserControl.Resources>
        <converters:EmptyStringToVisibilityConverter x:Key="EmptyStringToVisibilityConverter"/>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        
        <!-- Стиль для строк DataGrid -->
        <Style x:Key="DataGridRowStyle" TargetType="DataGridRow">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsActive}" Value="False">
                    <Setter Property="Foreground" Value="Gray"/>
                    <Setter Property="Opacity" Value="0.7"/>
                </DataTrigger>
                <!-- Триггер для наведения курсора -->
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#E0E0E0"/>
                    <Setter Property="Foreground" Value="Black"/>
                </Trigger>
                <!-- Триггер для выбранной строки -->
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#B0C4DE"/>
                    <Setter Property="Foreground" Value="Black"/>
                </Trigger>
                <!-- Триггер для неактивной выбранной строки -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsActive}" Value="False"/>
                        <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource Self}}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Foreground" Value="#333333"/>
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <TextBlock Grid.Row="0" 
                   Text="Управление пользователями" 
                   FontSize="20" 
                   FontWeight="Bold" 
                   Margin="0,0,0,15"/>
        
        <!-- Search and Actions Panel -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,15">
            <!-- Search Box -->
            <TextBox Width="200" 
                     Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                     Margin="0,0,10,0">
                <TextBox.Style>
                    <Style TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="TextBox">
                                    <Border Background="#FFF0F0F0" 
                                            BorderBrush="#FFCCCCCC" 
                                            BorderThickness="1" 
                                            CornerRadius="3">
                                        <Grid>
                                            <TextBlock Text="Поиск..." 
                                                       Foreground="Gray" 
                                                       Margin="5,0"
                                                       VerticalAlignment="Center"
                                                       Visibility="{Binding Text, 
                                                        RelativeSource={RelativeSource TemplatedParent}, 
                                                        Converter={StaticResource EmptyStringToVisibilityConverter}}"/>
                                            <ScrollViewer x:Name="PART_ContentHost" 
                                                          VerticalAlignment="Center"/>
                                        </Grid>
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </TextBox.Style>
            </TextBox>
            
            <!-- Action Buttons -->
            <Button Content="Добавить пользователя" 
                    Command="{Binding AddUserCommand}"
                    Margin="0,0,10,0"
                    Padding="10,5"/>
            
            <Button Content="Обновить" 
                    Command="{Binding RefreshCommand}"
                    Padding="10,5"/>
        </StackPanel>
        
        <!-- Users DataGrid -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <DataGrid ItemsSource="{Binding Users}"
                      SelectedItem="{Binding SelectedUser}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      RowStyle="{StaticResource DataGridRowStyle}"
                      Grid.Row="0">
                
                <DataGrid.Columns>
                    <DataGridTextColumn Header="ID" 
                                        Binding="{Binding Id}" 
                                        Width="Auto"
                                        Visibility="Collapsed"/>
                    
                    <DataGridTextColumn Header="Email" 
                                        Binding="{Binding Email}" 
                                        Width="180"/>
                    
                    <DataGridTextColumn Header="ФИО" 
                                        Binding="{Binding FullName}" 
                                        Width="200"/>
                    
                    <DataGridTextColumn Header="Роль" 
                                        Binding="{Binding Role}" 
                                        Width="100"/>
                    
                    <DataGridTextColumn Header="Отдел" 
                                        Binding="{Binding Department}" 
                                        Width="70"/>
                    
                    <DataGridCheckBoxColumn Header="Статус" 
                                            Binding="{Binding IsActive, Mode=OneWay}"
                                            Width="70"/>
                    
                </DataGrid.Columns>
                
                <DataGrid.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Изменить" 
                              Command="{Binding EditUserCommand}"/>
                    <MenuItem Header="Сменить пароль"
                              Command="{Binding ChangePasswordCommand}"/>
                    <MenuItem Header="Активировать/деактивировать"
                              Command="{Binding ChangeUserStatusCommand}"/>
                    <MenuItem Header="Удалить"
                              Command="{Binding DeleteUserCommand}"/>
                </ContextMenu>    
                </DataGrid.ContextMenu>
                
            </DataGrid>
            
            <!-- Loading Indicator -->
            <Grid Grid.Row="1" 
                  Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}"
                  Height="30"
                  VerticalAlignment="Bottom"
                  Background="#F0F0F0">
                <ProgressBar IsIndeterminate="True"
                             Height="20"
                             Margin="10,5"/>
            </Grid>
        </Grid>
        
        <!-- Error Message -->
        <TextBlock Grid.Row="3"
                   Text="{Binding ErrorMessage}"
                   Foreground="Red"
                   Margin="0,10,0,0"
                   TextWrapping="Wrap"
                   Visibility="{Binding ErrorMessage, Converter={StaticResource StringToVisibilityConverter}}"/>
        
        <!-- Action Buttons for Selected User -->
        <StackPanel Grid.Row="3" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Right"
                    Margin="0,10,0,0">
            <!-- <Button Content="Деактивировать"  -->
            <!--         Command="{Binding DeactivateUserCommand}" -->
            <!--         Margin="0,0,10,0" -->
            <!--         Padding="10,5"/> -->
            <!-- -->
            <!-- <Button Content="Активировать"  -->
            <!--         Command="{Binding ActivateUserCommand}" -->
            <!--         Padding="10,5"/> -->
        </StackPanel>
    </Grid>
</UserControl>